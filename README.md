# Boring libjpeg-turbo

This is a slimmed-down fork of the
[libjpeg-turbo](https://github.com/libjpeg-turbo/libjpeg-turbo) code.

**boring-libjpeg-turbo removes over 62k lines of code (66.71%) from the
upstream libjpeg-turbo version 2.1.4.**

```
             boring  upstream
ansic:        22067     57068
asm:           8754     30823
java:             0      3273
javascript:       0      1172
sh:             112      1114
pascal:         453       453
cpp:              0       390

total:        31386     94293
ratio:         3.00x
inverse:      33.29%  =  100% - 66.71%
```

The `sloccount` tool harmlessly miscategorizes the `simd/nasm/*` files as
"pascal".


## Fewer Security Issues

The 'boring' name is inspired by how
[BoringSSL](https://boringssl.googlesource.com/boringssl/) relates to OpenSSL.

As of the time of writing, the latest tagged libjpeg-turbo version is 2.1.4
(commit 8162eddf, August 2022). There have been 25 commits in the 5 months
since then (up to commit 94a2b953, January 2023). This includes 4 commits
addressing [buffer
overrun](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/94a2b953421124a425027ee97d8c858f414fbf7e),
[integer division by
zero](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/dc4a93fab38b42d29b89a533409e012570180e28),
[array
overrun](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/45cd2ded885f9a74bc1b7e25c07181802bad32ac)
and [another buffer
overrun](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/78a36f6dc36ac7898a9c299e4a2bc58cb1a8eba4).

None of these 4 commits need porting to boring-libjpeg-turbo, because this
downstream fork has already removed or disabled the relevant configuration
option or code.

The safest code is deleted code.


## Changes from Upstream

boring-libjpeg-turbo is based on libjpeg-turbo version 2.1.4 ([commit
8162eddf](https://github.com/libjpeg-turbo/libjpeg-turbo/commit/8162eddf041e0be26f5c671bb6528723c55fed9d),
August 2022).

From there, it removes (or ignores, marked with "BORING\_NAME" or "notboring")
a lot of code. The original libjpeg-turbo library is relatively featureful and
flexible. For example, it allows:

- Arithmetic-coded JPEG images. Even though the relevant patents have finally
  expired, such images are very, very rare in practice.
- Transcoding (e.g. 90 degree rotations) that can be more efficient (and
  'lossless') than a naive "decode RGB + rotate + re-encode YCbCr" workflow.
- Overriding the default malloc-based memory manager, on embedded systems with
  limited physical memory.
- Java bindings for the C library.

Such use cases are rare. This slimmed-down fork only targets those features
used by a modern web browser (e.g. Chromium) on modern, non-embedded hardware
(e.g. 32-bit minimum CPU, 24-bit minimum color display). It targets building a
library for "I just want to encode or decode a JPEG, almost always using the
default options", not feature-rich command line tools too.

For example, our `jconfig.h` file is hard-coded. In the upstream libjpeg-turbo,
it is generated by a user-initiated configuration step.

It's not that library features are bad, per se. *It's that a smaller code base
is easier to understand, customize, audit for security, etc.* If you want the
full feature set, use libjpeg-turbo.


### Removed File Format Support

- 12 (not 8) bits per sample.
- Arithmetic coding.
- Lossless.


### Removed C Library Features

- Alternative 'legacy' IDCT implementations.
- Custom memory management, including virtual memory ('backing stores').
- IDCT scaling.
- Input smoothing, designed for 8-bit color input files (e.g. GIFs).
- Merged upsampling (merging upsampling with color conversion, which is fast
  but uses 'sloppy' chroma upsampling).
- Quantization from 24-bit (or 32-bit) to 8-bit color.
- RGB565 color space.
- Runtime configuration via environment variables (e.g. JPEGMEM,
  JSIMD\_FORCENONE, etc).
- 'Sloppy' (low quality, box filter) chroma upsampling, as opposed to the
  default 'fancy' (high quality, triangle filter) algorithm.


### Removed SIMD Code

- i386 (but not x86\_64).
- MIPS.
- MIPS64.
- PowerPC.


## Documentation

The `LICENSE.md` file (and the `README.ijg` file it links to) were copied
unchanged from the upstream libjpeg-turbo repository to this repository but, in
general, see upstream for documentation. Its `libjpeg.txt`, `structure.txt` and
`usage.txt` files are still worth reading, even if they don't apply 100% to
"boring-libjpeg-turbo".

Copied unchanged means that they discuss "libjpeg-turbo" even though this
repository is "boring-libjpeg-turbo".


## Building

Some simple scripts (`./build-boring-x86_64-elf64.sh && ./run-boring-tests.sh
&& ./clean-boring.sh`) are provided as a basic regression-catching check, when
modifying this repository. But we don't otherwise provide build scripts,
makefiles, etc.

For larger Chromium-like projects that want a static library, they already have
their own build system for third party code (and different projects use
different build systems). Use that instead.

For Operating Systems that want to provide a dynamic library, or utility
programs like `cjpeg` and `djpeg`, use the upstream libjpeg-turbo instead. For
example, this repository's `cjpeg` program speaks fewer image file formats (and
supports none of the command-line switches) than what many Linux distributions
ship as `/usr/bin/cjpeg`. This repository's `cjpeg` only exists to support the
previously mentioned basic regression test.


## Migrating from libjpeg or libjpeg-turbo

There were two C macros added to boring-libjpeg-turbo's `jpeglib.h`:

```
/*
 * This macro lets application code (that #include's this file) conditionally
 * enable or disable code (via #ifdef) depending on whether it's using the
 * upstream libjpeg-turbo (or plain libjpeg) or boring-libjpeg-turbo.
 */
#define BORING_LIBJPEG_TURBO 1

/*
 * BORING_LIBJPEG_TURBO_USES_SAME_NAMES is not defined by default, which means
 * that the libjpeg struct fields and enum names that no longer have any effect
 * have been renamed. For example, "cinfo.arith_code" becomes
 * "cinfo.notboring_arith_code" and setting that field does nothing.
 *
 * Thus, application code that refers to those names won't compile (when using
 * boring-libjpeg-turbo instead of libjpeg-turbo). Failing noisily is
 * preferable to silently accepting (but ignoring) those fields. However, if
 * it's not easy to edit that application code, you can define this macro
 * instead (whether by a #define in its C code or by a compiler flag) before
 * #include'ing this file. The names will be the same and setting those struct
 * fields or using those enum values will compile but silently have no effect.
 */
#ifdef BORING_LIBJPEG_TURBO_USES_SAME_NAMES
#define BORING_NAME(x) x
#else
#define BORING_NAME(x) notboring_##x
#endif
```

If such 'notboring' struct fields and enum names aren't touched (e.g. you're
just using the defaults) then the output from the upstream libjpeg-turbo and
the downstream boring-libjpeg-turbo libraries should be identical.
